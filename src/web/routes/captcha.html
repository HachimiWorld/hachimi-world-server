<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Captcha</title>
</head>
<body>
<script src="https://challenges.cloudflare.com/turnstile/v0/api.js?render=explicit" defer></script>

<div style="text-align: center; margin-top: 20vh;">
    <div>正在进行人机验证，请稍后</div>
    <div id="my-widget" style="margin-top: 12px"></div>
    <div id="status" style="margin-top: 12px"></div>
</div>

<script>
    const API_BASE_URL = "{{API_BASE_URL}}";
    const SITE_KEY = "{{SITE_KEY}}";

    window.onload = function() {
        const status = document.querySelector("#status")
        // Get query from location
        const query = window.location.search.substring(1);
        // Parse query into object
        const vars = query.split("&");
        const queryObject = {};
        for (let i = 0; i < vars.length; i++) {
            const pair = vars[i].split("=");
            queryObject[pair[0]] = decodeURIComponent(pair[1]);
        }
        let captcha_key = queryObject.captcha_key

        turnstile.render('#my-widget', {
            sitekey: SITE_KEY,
            theme: 'light',
            callback: function(token) {
                status.textContent = "验证中，请稍后"
                const url = API_BASE_URL + "/auth/captcha/submit"
                const data = {
                    captcha_key: captcha_key,
                    token: token
                }
                // POST Json
                fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                }).then(response => {
                    response.json()
                        .then(data => {
                            if (data.ok) {
                                status.textContent = "验证通过，请直接关闭本窗口"
                                window.close()
                            } else {
                                status.textContent = "验证失败: " + data.data.msg
                            }
                        })
                        .catch(() => {
                            status.textContent = "验证失败"
                        })
                }).catch(reason => {
                    status.textContent = "验证失败"
                })
            }
        });
    };
</script>
</body>
</html>